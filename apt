#!/bin/bash

# Apt - 简单的AUR助手
# 版本: 1.0

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # 无颜色

# 配置
AUR_URL="https://aur.archlinux.org"
TEMP_DIR="/tmp/apt-$$"
PACMAN="/usr/bin/pacman"

# 错误处理
set -e

# 清理函数
cleanup() {
    rm -rf "$TEMP_DIR" 2>/dev/null
    exit
}

trap cleanup EXIT INT TERM

# 显示帮助
show_help() {
    cat << EOF
Apt - AUR助手

用法: apt <命令> [选项]

命令:
    install <包名>     安装AUR软件包
    search <关键词>     搜索AUR软件包
    remove <包名>       删除已安装的软件包
    show [包名]         显示已安装软件包信息
    help                显示帮助信息

示例:
    apt install google-chrome
    apt search browser
    apt remove google-chrome
    apt show
    apt show google-chrome
EOF
}

# 检查依赖
check_deps() {
    local deps=("git" "base-devel" "pacman")
    local missing=()
    
    for dep in "${deps[@]}"; do
        if ! pacman -Qi "$dep" &>/dev/null; then
            missing+=("$dep")
        fi
    done
    
    if [ ${#missing[@]} -ne 0 ]; then
        echo -e "${YELLOW}警告: 缺少以下依赖: ${missing[*]}${NC}"
        echo "是否安装? [y/N] "
        read -r answer
        if [[ "$answer" =~ ^[Yy]$ ]]; then
            sudo pacman -S --needed base-devel git
        fi
    fi
}

# 搜索软件包
search_packages() {
    local query="$1"
    if [ -z "$query" ]; then
        echo -e "${RED}错误: 请指定搜索关键词${NC}"
        return 1
    fi
    
    echo -e "${BLUE}正在搜索: $query${NC}"
    
    # 调用AUR RPC接口搜索
    local search_result=$(curl -s "$AUR_URL/rpc/?v=5&type=search&arg=$query")
    
    # 解析JSON结果
    local resultcount=$(echo "$search_result" | grep -o '"resultcount":[0-9]*' | cut -d':' -f2)
    
    if [ "$resultcount" -eq 0 ]; then
        echo -e "${YELLOW}未找到相关软件包${NC}"
        return 0
    fi
    
    echo -e "${GREEN}找到 $resultcount 个软件包:${NC}\n"
    
    # 显示搜索结果
    echo "$search_result" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    for pkg in data['results']:
        print(f\"\033[1;34m{pkg['Name']}\033[0m \033[0;32m{pkg['Version']}\033[0m\")
        print(f\"  {pkg['Description']}\")
        print(f\"  人气: {pkg['NumVotes']} | 维护者: {pkg.get('Maintainer', '无')}\")
        print()
except:
    pass
"
}

# 安装软件包
install_package() {
    local pkgname="$1"
    if [ -z "$pkgname" ]; then
        echo -e "${RED}错误: 请指定要安装的软件包${NC}"
        return 1
    fi
    
    # 检查是否已安装
    if pacman -Qi "$pkgname" &>/dev/null; then
        echo -e "${YELLOW}软件包 $pkgname 已经安装${NC}"
        return 0
    fi
    
    echo -e "${BLUE}正在获取 $pkgname 信息...${NC}"
    
    # 获取包信息
    local pkg_info=$(curl -s "$AUR_URL/rpc/?v=5&type=info&arg[]=$pkgname")
    
    if ! echo "$pkg_info" | grep -q '"resultcount":1'; then
        echo -e "${RED}错误: 未找到软件包 $pkgname${NC}"
        return 1
    fi
    
    # 显示包信息
    echo "$pkg_info" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    pkg = data['results'][0]
    print(f\"\033[1;34m{pkg['Name']}\033[0m \033[0;32m{pkg['Version']}\033[0m\")
    print(f\"描述: {pkg['Description']}\")
    print(f\"依赖: {', '.join(pkg.get('Depends', []))}\")
    print(f\"构建依赖: {', '.join(pkg.get('MakeDepends', []))}\")
except:
    pass
"
    
    echo -e "\n${YELLOW}是否继续安装? [y/N] ${NC}"
    read -r answer
    if [[ ! "$answer" =~ ^[Yy]$ ]]; then
        echo "安装取消"
        return 0
    fi
    
    # 创建临时目录并下载PKGBUILD
    mkdir -p "$TEMP_DIR/$pkgname"
    cd "$TEMP_DIR/$pkgname"
    
    echo -e "${BLUE}正在下载PKGBUILD...${NC}"
    git clone --depth 1 "https://aur.archlinux.org/$pkgname.git" .
    
    if [ ! -f "PKGBUILD" ]; then
        echo -e "${RED}错误: 无法获取PKGBUILD${NC}"
        return 1
    fi
    
    # 检查依赖
    echo -e "${BLUE}正在检查依赖...${NC}"
    local deps=$(source PKGBUILD 2>/dev/null; echo "${depends[@]} ${makedepends[@]}")
    
    # 过滤已安装的依赖
    local missing_deps=()
    for dep in $deps; do
        # 移除版本约束
        dep=$(echo "$dep" | sed 's/[<>=].*//')
        if ! pacman -Qi "$dep" &>/dev/null; then
            missing_deps+=("$dep")
        fi
    done
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo -e "${YELLOW}需要安装以下依赖: ${missing_deps[*]}${NC}"
        echo "是否安装? [y/N] "
        read -r answer
        if [[ "$answer" =~ ^[Yy]$ ]]; then
            sudo pacman -S --needed "${missing_deps[@]}"
        else
            echo "依赖未满足，安装取消"
            return 1
        fi
    fi
    
    # 构建和安装
    echo -e "${BLUE}开始构建 $pkgname...${NC}"
    makepkg -si --noconfirm
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓ 成功安装 $pkgname${NC}"
    else
        echo -e "${RED}✗ 安装失败 $pkgname${NC}"
        return 1
    fi
}

# 删除软件包
remove_package() {
    local pkgname="$1"
    if [ -z "$pkgname" ]; then
        echo -e "${RED}错误: 请指定要删除的软件包${NC}"
        return 1
    fi
    
    # 检查是否已安装
    if ! pacman -Qi "$pkgname" &>/dev/null; then
        echo -e "${RED}错误: 软件包 $pkgname 未安装${NC}"
        return 1
    fi
    
    # 显示包信息
    pacman -Qi "$pkgname"
    
    echo -e "\n${YELLOW}确定要删除 $pkgname? [y/N] ${NC}"
    read -r answer
    if [[ "$answer" =~ ^[Yy]$ ]]; then
        sudo pacman -R "$pkgname"
        echo -e "${GREEN}✓ 已删除 $pkgname${NC}"
    else
        echo "操作取消"
    fi
}

# 显示包信息
show_package() {
    local pkgname="$1"
    
    if [ -z "$pkgname" ]; then
        # 显示所有已安装的AUR包
        echo -e "${BLUE}已安装的AUR软件包:${NC}\n"
        pacman -Qm | while read -r pkg ver; do
            echo -e "${GREEN}$pkg${NC} $ver"
        done
    else
        # 显示指定包信息
        if ! pacman -Qi "$pkgname" &>/dev/null; then
            echo -e "${RED}错误: 软件包 $pkgname 未安装${NC}"
            return 1
        fi
        
        echo -e "${BLUE}软件包信息:${NC}\n"
        pacman -Qi "$pkgname"
        
        # 检查是否为AUR包
        if pacman -Qm | grep -q "^$pkgname "; then
            echo -e "\n${YELLOW}此软件包来自AUR${NC}"
        fi
    fi
}

# 主函数
main() {
    # 检查命令
    if [ $# -eq 0 ] || [ "$1" = "help" ]; then
        show_help
        return 0
    fi
    
    # 检查必要工具
    if ! command -v curl &>/dev/null; then
        echo -e "${RED}错误: 需要安装 curl${NC}"
        exit 1
    fi
    
    if ! command -v python3 &>/dev/null; then
        echo -e "${RED}错误: 需要安装 python3${NC}"
        exit 1
    fi
    
    # 检查依赖
    check_deps
    
    # 解析命令
    case "$1" in
        install)
            install_package "$2"
            ;;
        search)
            search_packages "$2"
            ;;
        remove)
            remove_package "$2"
            ;;
        show)
            show_package "$2"
            ;;
        *)
            echo -e "${RED}未知命令: $1${NC}"
            show_help
            exit 1
            ;;
    esac
}

# 运行主函数
main "$@"